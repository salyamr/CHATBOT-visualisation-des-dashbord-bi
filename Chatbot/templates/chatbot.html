{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alten ChatBot Assistant IA</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="icon" type="image/png" href="{% static 'images/logo-ALTEN.jpg' %}">
    <style>
        /* Styles existants conserv√©s */
        .btn-file {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: none;
            color: #333;
            padding: 15px;
            font-size: 16px;
            transition: all 0.3s ease;
            border-left: 1px solid #FFD700;
        }

        .btn-voice {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: none;
            color: #333;
            padding: 15px;
            font-size: 16px;
            transition: all 0.3s ease;
            border-left: 1px solid #FFD700;
        }

        .btn-file:hover, .btn-voice:hover {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: white;
        }

        .listening {
            animation: pulse 1.5s infinite;
            background: linear-gradient(135deg, #FF4444 0%, #FF0000 100%) !important;
            color: white !important;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 68, 68, 0); }
        }

        body {
            background: linear-gradient(135deg, #2c1810 0%, #1a0f0a 50%, #0f0505 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .chat-container {
            max-width: 800px;
            height: 90vh;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(255, 215, 0, 0.2);
            overflow: hidden;
            position: relative;
            z-index: 10;
            border: 2px solid rgba(255, 215, 0, 0.3);
        }

        .chat-header {
            background: linear-gradient(135deg, #FFFF00 0%, #FF0000 100%);
            color: #333;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .chat-messages {
            height: calc(90vh - 280px);
            overflow-y: auto;
            padding: 20px;
            background: linear-gradient(180deg, #f8f9fa 0%, #ffffff 100%);
        }

        .message {
            margin-bottom: 15px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user { text-align: right; }
        .message.bot { text-align: left; }

        .message-bubble {
            display: inline-block;
            max-width: 75%;
            padding: 12px 18px;
            border-radius: 20px;
            word-wrap: break-word;
            position: relative;
        }

        .message.user .message-bubble {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #333;
            border-bottom-right-radius: 5px;
            font-weight: 500;
        }

        .message.bot .message-bubble {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            color: #333;
            border: 2px solid #FFD700;
            border-bottom-left-radius: 5px;
        }

        .understanding-indicator {
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid #FFD700;
            border-radius: 10px;
            padding: 10px;
            margin: 10px 0;
            font-size: 0.9em;
        }

        .intent-badge {
            background: linear-gradient(135deg, #FF4444 0%, #FFD700 100%);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-right: 8px;
        }

        .confidence-bar {
            height: 4px;
            background: #eee;
            border-radius: 2px;
            margin: 5px 0;
            overflow: hidden;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #FF4444, #FFD700);
            transition: width 0.5s ease;
        }

        .form-control {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #FFD700;
            color: #333;
            padding: 15px 20px;
            font-size: 16px;
            border-radius: 25px;
        }

        .btn-send {
            background: linear-gradient(135deg, #FF4444 0%, #FFD700 100%);
            border: none;
            color: white;
            padding: 15px 25px;
            font-size: 16px;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .typing-indicator {
            display: none;
            padding: 10px 0;
        }

        .typing-dots span {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #FFD700;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dots span:nth-child(1) { left: 0; animation-delay: -0.32s; background: #FF4444; }
        .typing-dots span:nth-child(2) { left: 15px; animation-delay: -0.16s; }
        .typing-dots span:nth-child(3) { left: 30px; background: #FF4444; }

        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        .suggestion-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 10px 0;
        }

        .suggestion-chip {
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid #FFD700;
            border-radius: 15px;
            padding: 6px 12px;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .suggestion-chip:hover {
            background: #FFD700;
            color: #333;
        }

        .ai-analysis {
            background: rgba(68, 68, 255, 0.05);
            border-left: 4px solid #FFD700;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
        }

        .chart-preview {
            text-align: center;
            margin: 15px 0;
            padding: 20px;
            background: rgba(255, 215, 0, 0.05);
            border-radius: 10px;
            border: 1px dashed #FFD700;
        }

        /* Nouveaux styles pour la case √† cocher graphique */
        .chart-mode-container {
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid #FFD700;
            border-radius: 15px;
            padding: 10px 15px;
            margin: 10px 0;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }

        .chart-mode-container:hover {
            background: rgba(255, 215, 0, 0.2);
        }

        .chart-mode-container.active {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
        }

        .chart-checkbox {
            width: 20px;
            height: 20px;
            accent-color: #FFD700;
        }

        .chart-mode-label {
            font-weight: 500;
            font-size: 14px;
            user-select: none;
            cursor: pointer;
            flex-grow: 1;
        }

        .chart-indicator {
            font-size: 12px;
            opacity: 0.8;
        }

        .generated-chart {
            margin: 15px 0;
            padding: 20px;
            background: white;
            border-radius: 10px;
            border: 2px solid #FFD700;
            box-shadow: 0 4px 20px rgba(255, 215, 0, 0.2);
        }
    </style>
</head>
<body>
    <div class="container-fluid d-flex justify-content-center align-items-center min-vh-100 p-3">
        <div class="chat-container">
            <!-- Header -->
            <div class="chat-header">
                <h3>
                    <span class="alten-logo">ALTEN</span>
                    <i class="fas fa-brain ms-2"></i> 
                    Assistant IA Avanc√©
                    <span class="online-indicator"></span>
                </h3>
                <small>Intelligence Artificielle ‚Ä¢ Analyse de Donn√©es ‚Ä¢ Visualisation</small>
            </div>
            
            <!-- Messages -->
            <div class="chat-messages" id="chatMessages">
                <div class="message bot">
                    <div class="message-bubble">
                        <i class="fas fa-robot" style="color: #FFD700;"></i> 
                        Bonjour ! Je suis votre assistant IA ALTEN avec compr√©hension naturelle du langage. 
                        Je peux analyser vos demandes et cr√©er des graphiques personnalis√©s. 
                        <br><br>
                        <strong>Essayez de me dire quelque chose comme :</strong>
                        <div class="suggestion-chips">
                            <span class="suggestion-chip" onclick="sendMessage('Je veux un graphique en barres des ventes par mois')">üìä Graphique des ventes</span>
                            <span class="suggestion-chip" onclick="sendMessage('Cr√©er un rapport sur les performances')">üìà Rapport de performance</span>
                            <span class="suggestion-chip" onclick="sendMessage('Analyser les donn√©es de production')">üîç Analyse production</span>
                        </div>
                    </div>
                    <div class="message-time">Maintenant</div>
                </div>
            </div>
            
            <!-- Typing Indicator -->
            <div class="typing-indicator" id="typingIndicator">
                <div style="position: relative; display: inline-block; width: 60px; height: 20px;">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                <small class="text-muted ms-3">L'IA ALTEN analyse votre demande...</small>
            </div>
            
            <!-- Input -->
            <div class="chat-input-container" style="padding: 20px; background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%); border-top: 2px solid #FFD700;">
                <!-- Case √† cocher pour mode graphique -->
                <div class="chart-mode-container" id="chartModeContainer">
                    <input type="checkbox" id="chartModeCheckbox" class="chart-checkbox">
                    <label for="chartModeCheckbox" class="chart-mode-label">
                        <i class="fas fa-chart-line me-2"></i>
                        Mode G√©n√©ration de Graphiques
                    </label>
                    <span class="chart-indicator" id="chartIndicator">
                        <i class="fas fa-info-circle"></i> D√©sactiv√©
                    </span>
                </div>

                <div class="input-group" style="border-radius: 25px; overflow: hidden; box-shadow: 0 4px 20px rgba(255, 215, 0, 0.2); border: 2px solid #FFD700;">
                    <input type="text" class="form-control" id="messageInput" placeholder="Dites-moi ce que vous voulez faire (ex: cr√©er un graphique, analyser des donn√©es...)" onkeypress="handleKeyPress(event)">
                    
                    <button class="btn btn-voice" id="voiceButton">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <button class="btn btn-send" onclick="processUserMessage()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Canvas cach√© pour les graphiques -->
    <canvas id="chartCanvas" style="display: none;"></canvas>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script>
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const typingIndicator = document.getElementById('typingIndicator');
        const chartModeCheckbox = document.getElementById('chartModeCheckbox');
        const chartModeContainer = document.getElementById('chartModeContainer');
        const chartIndicator = document.getElementById('chartIndicator');

        // Gestion du mode graphique
        chartModeCheckbox.addEventListener('change', function() {
            if (this.checked) {
                chartModeContainer.classList.add('active');
                chartIndicator.innerHTML = '<i class="fas fa-chart-line"></i> Activ√©';
                messageInput.placeholder = "D√©crivez le graphique que vous voulez cr√©er (ex: graphique en barres des demandes par mois)";
                addMessage("üìä <strong>Mode Graphique Activ√©!</strong><br>Vos requ√™tes seront maintenant trait√©es pour g√©n√©rer des graphiques bas√©s sur la base de donn√©es ALTEN.");
            } else {
                chartModeContainer.classList.remove('active');
                chartIndicator.innerHTML = '<i class="fas fa-info-circle"></i> D√©sactiv√©';
                messageInput.placeholder = "Dites-moi ce que vous voulez faire (ex: cr√©er un graphique, analyser des donn√©es...)";
                addMessage("üí¨ <strong>Mode Chat Normal</strong><br>Retour au mode conversation standard.");
            }
        });

        // Syst√®me de compr√©hension IA am√©lior√©
        const intentPatterns = {
            'graphique': {
                keywords: ['graphique', 'graphe', 'chart', 'diagramme', 'visualisation', 'courbe', 'barres', 'secteur', 'histogramme'],
                types: ['barres', 'courbe', 'secteur', 'radar', 'histogramme', 'scatter', 'line'],
                response: "Je comprends que vous voulez cr√©er un graphique"
            },
            'rapport': {
                keywords: ['rapport', 'report', 'analyse', 'synth√®se', 'r√©sum√©', 'dashboard', 'tableau de bord'],
                response: "Je vais g√©n√©rer un rapport d'analyse"
            },
            'donn√©es': {
                keywords: ['donn√©es', 'data', 'informations', 'chiffres', 'statistiques', 'metrics', 'kpi'],
                response: "Je vais analyser vos donn√©es"
            },
            'performance': {
                keywords: ['performance', 'rendement', 'efficacit√©', 'productivit√©', 'r√©sultats', 'metrics'],
                response: "Analysons les performances"
            },
            'ventes': {
                keywords: ['ventes', 'chiffre d\'affaires', 'ca', 'revenus', 'commercial', 'clients'],
                response: "Analyse des donn√©es de vente"
            },
            'production': {
                keywords: ['production', 'fabrication', 'manufacturing', 'usine', 'qualit√©', 'd√©fauts'],
                response: "Analyse de la production"
            }
        };

        function analyzeIntent(message) {
            const lowerMessage = message.toLowerCase();
            let bestMatch = { intent: 'g√©n√©ral', confidence: 0, details: {} };
            
            for (const [intent, config] of Object.entries(intentPatterns)) {
                let confidence = 0;
                let matchedKeywords = [];
                
                // V√©rifier les mots-cl√©s principaux
                for (const keyword of config.keywords) {
                    if (lowerMessage.includes(keyword)) {
                        confidence += 0.3;
                        matchedKeywords.push(keyword);
                    }
                }
                
                // Bonus pour les types sp√©cifiques (graphiques)
                if (config.types) {
                    for (const type of config.types) {
                        if (lowerMessage.includes(type)) {
                            confidence += 0.4;
                            bestMatch.details.chartType = type;
                        }
                    }
                }
                
                // Recherche de p√©riodes temporelles
                const timePatterns = ['mois', 'ann√©e', 'jour', 'semaine', 'trimestre', 'mensuel', 'annuel'];
                for (const period of timePatterns) {
                    if (lowerMessage.includes(period)) {
                        confidence += 0.2;
                        bestMatch.details.timePeriod = period;
                    }
                }
                
                if (confidence > bestMatch.confidence) {
                    bestMatch = {
                        intent,
                        confidence: Math.min(confidence, 1.0),
                        response: config.response,
                        matchedKeywords,
                        details: bestMatch.details
                    };
                }
            }
            
            return bestMatch;
        }

        function generateIntelligentResponse(analysis, originalMessage) {
            let response = `<div class="ai-analysis">`;
            response += `<strong><i class="fas fa-brain"></i> Analyse IA :</strong><br>`;
            response += `<span class="intent-badge">${analysis.intent.toUpperCase()}</span>`;
            response += `${analysis.response}<br>`;
            
            // Barre de confiance
            response += `<div class="confidence-bar">`;
            response += `<div class="confidence-fill" style="width: ${analysis.confidence * 100}%"></div>`;
            response += `</div>`;
            response += `<small>Confiance: ${Math.round(analysis.confidence * 100)}%</small>`;
            
            if (analysis.matchedKeywords.length > 0) {
                response += `<br><small><strong>Mots-cl√©s d√©tect√©s:</strong> ${analysis.matchedKeywords.join(', ')}</small>`;
            }
            
            response += `</div>`;
            
            // R√©ponse personnalis√©e selon l'intention
            switch (analysis.intent) {
                case 'graphique':
                    response += `<div class="chart-preview">`;
                    response += `<i class="fas fa-chart-${analysis.details.chartType === 'barres' ? 'bar' : 'line'} fa-3x" style="color: #FFD700;"></i><br>`;
                    response += `<strong>Graphique ${analysis.details.chartType || 'personnalis√©'}</strong><br>`;
                    if (analysis.details.timePeriod) {
                        response += `<small>P√©riode: ${analysis.details.timePeriod}</small><br>`;
                    }
                    response += `<button class="btn btn-sm btn-primary mt-2" onclick="generateChart('${analysis.details.chartType || 'auto'}')">`;
                    response += `<i class="fas fa-magic"></i> G√©n√©rer le graphique`;
                    response += `</button>`;
                    response += `</div>`;
                    break;
                    
                case 'rapport':
                    response += `<div class="chart-preview">`;
                    response += `<i class="fas fa-file-chart fa-3x" style="color: #FF4444;"></i><br>`;
                    response += `<strong>Rapport d'analyse</strong><br>`;
                    response += `<button class="btn btn-sm btn-success mt-2" onclick="generateReport()">`;
                    response += `<i class="fas fa-file-alt"></i> Cr√©er le rapport`;
                    response += `</button>`;
                    response += `</div>`;
                    break;
                    
                default:
                    response += `<div class="suggestion-chips">`;
                    response += `<span class="suggestion-chip" onclick="sendMessage('Cr√©er un graphique en barres')">üìä Graphique</span>`;
                    response += `<span class="suggestion-chip" onclick="sendMessage('G√©n√©rer un rapport')">üìÑ Rapport</span>`;
                    response += `<span class="suggestion-chip" onclick="sendMessage('Analyser les donn√©es')">üîç Analyse</span>`;
                    response += `</div>`;
            }
            
            // Suggestions contextuelles
            response += `<br><div class="understanding-indicator">`;
            response += `<small><strong>üí° Suggestions :</strong><br>`;
            response += `‚Ä¢ Soyez plus pr√©cis sur le type de graphique (barres, courbe, secteur)<br>`;
            response += `‚Ä¢ Mentionnez la p√©riode d'analyse (mensuel, annuel)<br>`;
            response += `‚Ä¢ Indiquez les variables √† analyser</small>`;
            response += `</div>`;
            
            return response;
        }

        function addMessage(text, isUser = false, showAnalysis = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'bot'}`;
            
            messageDiv.innerHTML = `
                <div class="message-bubble">
                    ${text}
                </div>
                <div class="message-time">${getCurrentTime()}</div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function getCurrentTime() {
            return new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
        }

        function showTyping() {
            typingIndicator.style.display = 'block';
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function hideTyping() {
            typingIndicator.style.display = 'none';
        }

        function processUserMessage() {
            const message = messageInput.value.trim();
            if (!message) return;

            addMessage(message, true);
            messageInput.value = '';
            showTyping();

            // D√©terminer l'URL selon le mode
            const isChartMode = chartModeCheckbox.checked;
            const url = isChartMode ? '/Alten/Chatbot/generate-chart/' : '/Alten/Chatbot/analyze/';
            
            if (isChartMode) {
                addMessage("üìä <em>Mode graphique activ√© - G√©n√©ration en cours...</em>");
            }

            // Appel de la fonction appropri√©e
            fetch(url, {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: 'text=' + encodeURIComponent(message)
            })
            .then(response => response.json())
            .then(data => {
                hideTyping();

                if (isChartMode && data.chart_data) {
                    // Afficher le graphique g√©n√©r√©
                    displayGeneratedChart(data);
                } else if (data.is_table) {
                    // Mode tableau normal
                    let tableHTML = "<table class='table table-bordered table-striped mt-2'>";
                    tableHTML += "<thead><tr>";
                    data.columns.forEach(col => tableHTML += `<th>${col}</th>`);
                    tableHTML += "</tr></thead><tbody>";
                    data.result.forEach(row => {
                        tableHTML += "<tr>";
                        Object.values(row).forEach(val => tableHTML += `<td>${val}</td>`);
                        tableHTML += "</tr>";
                    });
                    tableHTML += "</tbody></table>";
                    addMessage(`<strong>ChatBot Alten :</strong><br>${tableHTML}`);
                } else if (data.result) {
                    addMessage(`<strong>ChatBot Alten :</strong><br>${data.result}`);
                } else if (data.error) {
                    addMessage(`‚ùå Erreur d'analyse :<br><span style='color:red'>${data.error}</span> recharger la page svp`);
                } else {
                    addMessage("‚ùå Erreur d'analyse inconnue. rechargez la page svp");
                }
            })
            .catch(error => {
                hideTyping();
                console.error('Erreur:', error);
                addMessage("‚ùå Erreur de connexion. V√©rifiez votre r√©seau.");
            });
        }

        function displayGeneratedChart(data) {
            const chartContainer = document.createElement('div');
            chartContainer.className = 'generated-chart';
            
            // Cr√©er un canvas pour le graphique
            const canvas = document.createElement('canvas');
            canvas.id = 'chart-' + Date.now();
            canvas.width = 600;
            canvas.height = 400;
            
            chartContainer.innerHTML = `
                <h5><i class="fas fa-chart-bar"></i> ${data.title || 'Graphique G√©n√©r√©'}</h5>
                <div style="position: relative; height: 400px;">
                    ${canvas.outerHTML}
                </div>
                <div class="mt-3">
                    <button class="btn btn-sm btn-outline-primary me-2" onclick="downloadChart('${canvas.id}')">
                        <i class="fas fa-download"></i> T√©l√©charger
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="regenerateChart()">
                        <i class="fas fa-redo"></i> R√©g√©n√©rer
                    </button>
                </div>
            `;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message bot';
            messageDiv.appendChild(chartContainer);
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Cr√©er le graphique avec Chart.js
            setTimeout(() => {
                const ctx = document.getElementById(canvas.id).getContext('2d');
                new Chart(ctx, {
                    type: data.chart_data.type || 'bar',
                    data: data.chart_data.data,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: data.title || 'Graphique ALTEN'
                            },
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: data.chart_data.options?.scales || {}
                    }
                });
            }, 100);
        }

        function downloadChart(canvasId) {
            const canvas = document.getElementById(canvasId);
            const url = canvas.toDataURL('image/png');
            const a = document.createElement('a');
            a.href = url;
            a.download = 'graphique-alten.png';
            a.click();
        }

        function regenerateChart() {
            addMessage("üîÑ R√©g√©n√©ration du graphique...");
            // Logique de r√©g√©n√©ration
        }

        function sendMessage(text) {
            messageInput.value = text;
            processUserMessage();
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                processUserMessage();
            }
        }

        function generateChart(type) {
            showTyping();
            addMessage(`üöÄ G√©n√©ration du graphique ${type} en cours...`, true);
            
            setTimeout(() => {
                hideTyping();
                addMessage(`‚úÖ <strong>Graphique g√©n√©r√© avec succ√®s!</strong><br>
                    <div class="chart-preview">
                        <i class="fas fa-chart-bar fa-4x" style="color: #FFD700;"></i><br>
                        <strong>Graphique ${type}</strong><br>
                        <button class="btn btn-sm btn-outline-primary mt-2">
                            <i class="fas fa-download"></i> T√©l√©charger
                        </button>
                    </div>`);
            }, 2000);
        }

        function generateReport() {
            showTyping();
            addMessage("üìä G√©n√©ration du rapport d'analyse...", true);
            
            setTimeout(() => {
                hideTyping();
                addMessage(`üìã <strong>Rapport g√©n√©r√©!</strong><br>
                    <div class="ai-analysis">
                        <strong>R√©sum√© ex√©cutif:</strong><br>
                        ‚Ä¢ ${Math.floor(Math.random() * 1000 + 500)} lignes de donn√©es analys√©es<br>
                        ‚Ä¢ ${Math.floor(Math.random() * 20 + 5)} variables identifi√©es<br>
                        ‚Ä¢ Tendances positives d√©tect√©es<br>
                        ‚Ä¢ Recommandations g√©n√©r√©es<br><br>
                        <button class="btn btn-sm btn-success">
                            <i class="fas fa-file-pdf"></i> T√©l√©charger PDF
                        </button>
                    </div>`);
            }, 3000);
        }

        // Reconnaissance vocale am√©lior√©e avec gestion d'erreurs
        function setupVoiceRecognition() {
            const voiceButton = document.getElementById('voiceButton');
            
            // V√©rifier le support de la reconnaissance vocale
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                voiceButton.disabled = true;
                voiceButton.title = "Reconnaissance vocale non support√©e par ce navigateur";
                voiceButton.innerHTML = '<i class="fas fa-microphone-slash"></i>';
                return;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new SpeechRecognition();
            
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'fr-FR';
            recognition.maxAlternatives = 1;

            let isListening = false;

            voiceButton.addEventListener('click', async () => {
                if (isListening) {
                    recognition.stop();
                    return;
                }

                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    stream.getTracks().forEach(track => track.stop());
                    
                    recognition.start();
                    isListening = true;
                    voiceButton.classList.add('listening');
                    messageInput.placeholder = "üé§ √âcoute en cours... Parlez maintenant!";
                    
                    addMessage("üé§ <em>Microphone activ√© - Parlez clairement...</em>");
                    
                } catch (error) {
                    console.error('Erreur microphone:', error);
                    let errorMessage = "‚ùå ";
                    
                    if (error.name === 'NotAllowedError') {
                        errorMessage += "Permission microphone refus√©e. Veuillez autoriser l'acc√®s au microphone dans les param√®tres de votre navigateur.";
                    } else if (error.name === 'NotFoundError') {
                        errorMessage += "Aucun microphone d√©tect√©. V√©rifiez votre mat√©riel audio.";
                    } else {
                        errorMessage += `Erreur microphone: ${error.message}`;
                    }
                    
                    addMessage(errorMessage);
                    
                    voiceButton.disabled = true;
                    setTimeout(() => {
                        voiceButton.disabled = false;
                    }, 3000);
                }
            });

            recognition.onstart = () => {
                voiceButton.innerHTML = '<i class="fas fa-stop"></i>';
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                const confidence = event.results[0][0].confidence;
                
                messageInput.value = transcript;
                messageInput.placeholder = chartModeCheckbox.checked 
                    ? "D√©crivez le graphique que vous voulez cr√©er..." 
                    : "Dites-moi ce que vous voulez faire...";
                
                const confidencePercent = Math.round(confidence * 100);
                addMessage(`üé§ <strong>Reconnaissance vocale</strong> (${confidencePercent}% confiance):<br>"${transcript}"`, true);
                
                if (confidence > 0.7) {
                    setTimeout(() => processUserMessage(), 800);
                } else {
                    addMessage("ü§î <em>Confiance faible. Voulez-vous reformuler ou corriger le texte?</em>");
                }
            };

            recognition.onspeechstart = () => {
                addMessage("üó£Ô∏è <em>Parole d√©tect√©e...</em>");
            };

            recognition.onspeechend = () => {
                addMessage("‚úÖ <em>Fin de parole d√©tect√©e</em>");
            };

            recognition.onerror = (event) => {
                console.error('Erreur reconnaissance vocale:', event.error);
                isListening = false;
                voiceButton.classList.remove('listening');
                voiceButton.innerHTML = '<i class="fas fa-microphone"></i>';
                messageInput.placeholder = chartModeCheckbox.checked 
                    ? "D√©crivez le graphique que vous voulez cr√©er..." 
                    : "Dites-moi ce que vous voulez faire...";
                
                let errorMessage = "‚ùå ";
                
                switch (event.error) {
                    case 'not-allowed':
                        errorMessage += "<strong>Permission refus√©e</strong><br>Veuillez autoriser l'acc√®s au microphone.";
                        break;
                    case 'no-speech':
                        errorMessage += "Aucune parole d√©tect√©e. Rapprochez-vous du microphone.";
                        break;
                    case 'audio-capture':
                        errorMessage += "Microphone non accessible. V√©rifiez votre mat√©riel.";
                        break;
                    case 'network':
                        errorMessage += "Erreur r√©seau. V√©rifiez votre connexion.";
                        break;
                    default:
                        errorMessage += `Erreur technique: ${event.error}`;
                }
                
                addMessage(errorMessage);
            };

            recognition.onend = () => {
                isListening = false;
                voiceButton.classList.remove('listening');
                voiceButton.innerHTML = '<i class="fas fa-microphone"></i>';
                messageInput.placeholder = chartModeCheckbox.checked 
                    ? "D√©crivez le graphique que vous voulez cr√©er..." 
                    : "Dites-moi ce que vous voulez faire...";
            };
        }

        // Initialisation
        messageInput.focus();
        setupVoiceRecognition();

        // Messages de bienvenue
        setTimeout(() => {
            addMessage(`üí° <strong>Nouvelle fonctionnalit√© - Mode Graphique!</strong><br>
                ‚Ä¢ Cochez la case "Mode G√©n√©ration de Graphiques" pour cr√©er des visualisations<br>
                ‚Ä¢ Bas√© sur votre base de donn√©es ALTEN (Demandes, Applications, Audits, etc.)<br>
                ‚Ä¢ Exemples: "graphique des demandes par mois", "√©volution des audits"<br><br>
                üé§ <strong>Reconnaissance vocale disponible</strong><br>
                Cliquez sur <i class="fas fa-microphone"></i> et parlez clairement!`);
        }, 2000);
    </script>
</body>
</html>