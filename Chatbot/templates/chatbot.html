{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alten ChatBot Assistant IA</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="icon" type="image/png" href="{% static 'images/logo-ALTEN.jpg' %}">
    <style>
        /* Styles existants conservés */
        .btn-file {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: none;
            color: #333;
            padding: 15px;
            font-size: 16px;
            transition: all 0.3s ease;
            border-left: 1px solid #FFD700;
        }

        .btn-voice {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: none;
            color: #333;
            padding: 15px;
            font-size: 16px;
            transition: all 0.3s ease;
            border-left: 1px solid #FFD700;
        }

        .btn-file:hover, .btn-voice:hover {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: white;
        }

        .listening {
            animation: pulse 1.5s infinite;
            background: linear-gradient(135deg, #FF4444 0%, #FF0000 100%) !important;
            color: white !important;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 68, 68, 0); }
        }

        body {
            background: linear-gradient(135deg, #2c1810 0%, #1a0f0a 50%, #0f0505 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .chat-container {
            max-width: 800px;
            height: 90vh;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(255, 215, 0, 0.2);
            overflow: hidden;
            position: relative;
            z-index: 10;
            border: 2px solid rgba(255, 215, 0, 0.3);
        }

        .chat-header {
            background: linear-gradient(135deg, #FFFF00 0%, #FF0000 100%);
            color: #333;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .chat-messages {
            height: calc(90vh - 280px);
            overflow-y: auto;
            padding: 20px;
            background: linear-gradient(180deg, #f8f9fa 0%, #ffffff 100%);
        }

        .message {
            margin-bottom: 15px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user { text-align: right; }
        .message.bot { text-align: left; }

        .message-bubble {
            display: inline-block;
            max-width: 75%;
            padding: 12px 18px;
            border-radius: 20px;
            word-wrap: break-word;
            position: relative;
        }

        .message.user .message-bubble {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #333;
            border-bottom-right-radius: 5px;
            font-weight: 500;
        }

        .message.bot .message-bubble {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            color: #333;
            border: 2px solid #FFD700;
            border-bottom-left-radius: 5px;
        }

        .understanding-indicator {
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid #FFD700;
            border-radius: 10px;
            padding: 10px;
            margin: 10px 0;
            font-size: 0.9em;
        }

        .intent-badge {
            background: linear-gradient(135deg, #FF4444 0%, #FFD700 100%);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-right: 8px;
        }

        .confidence-bar {
            height: 4px;
            background: #eee;
            border-radius: 2px;
            margin: 5px 0;
            overflow: hidden;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #FF4444, #FFD700);
            transition: width 0.5s ease;
        }

        .form-control {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #FFD700;
            color: #333;
            padding: 15px 20px;
            font-size: 16px;
            border-radius: 25px;
        }

        .btn-send {
            background: linear-gradient(135deg, #FF4444 0%, #FFD700 100%);
            border: none;
            color: white;
            padding: 15px 25px;
            font-size: 16px;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .typing-indicator {
            display: none;
            padding: 10px 0;
        }

        .typing-dots span {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #FFD700;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dots span:nth-child(1) { left: 0; animation-delay: -0.32s; background: #FF4444; }
        .typing-dots span:nth-child(2) { left: 15px; animation-delay: -0.16s; }
        .typing-dots span:nth-child(3) { left: 30px; background: #FF4444; }

        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        .suggestion-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 10px 0;
        }

        .suggestion-chip {
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid #FFD700;
            border-radius: 15px;
            padding: 6px 12px;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .suggestion-chip:hover {
            background: #FFD700;
            color: #333;
        }

        .ai-analysis {
            background: rgba(68, 68, 255, 0.05);
            border-left: 4px solid #FFD700;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
        }

        .chart-preview {
            text-align: center;
            margin: 15px 0;
            padding: 20px;
            background: rgba(255, 215, 0, 0.05);
            border-radius: 10px;
            border: 1px dashed #FFD700;
        }

        /* Nouveaux styles pour la case à cocher graphique */
        .chart-mode-container {
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid #FFD700;
            border-radius: 15px;
            padding: 10px 15px;
            margin: 10px 0;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }

        .chart-mode-container:hover {
            background: rgba(255, 215, 0, 0.2);
        }

        .chart-mode-container.active {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
        }

        .chart-checkbox {
            width: 20px;
            height: 20px;
            accent-color: #FFD700;
        }

        .chart-mode-label {
            font-weight: 500;
            font-size: 14px;
            user-select: none;
            cursor: pointer;
            flex-grow: 1;
        }

        .chart-indicator {
            font-size: 12px;
            opacity: 0.8;
        }

        .generated-chart {
            margin: 15px 0;
            padding: 20px;
            background: white;
            border-radius: 10px;
            border: 2px solid #FFD700;
            box-shadow: 0 4px 20px rgba(255, 215, 0, 0.2);
        }
    </style>
</head>
<body>
    <div class="container-fluid d-flex justify-content-center align-items-center min-vh-100 p-3">
        <div class="chat-container">
            <!-- Header -->
            <div class="chat-header">
                <h3>
                    <span class="alten-logo">ALTEN</span>
                    <i class="fas fa-brain ms-2"></i> 
                    Assistant IA Avancé
                    <span class="online-indicator"></span>
                </h3>
                <small>Intelligence Artificielle • Analyse de Données • Visualisation</small>
            </div>
            
            <!-- Messages -->
            <div class="chat-messages" id="chatMessages">
                <div class="message bot">
                    <div class="message-bubble">
                        <i class="fas fa-robot" style="color: #FFD700;"></i> 
                        Bonjour ! Je suis votre assistant IA ALTEN avec compréhension naturelle du langage. 
                        Je peux analyser vos demandes et créer des graphiques personnalisés. 
                        <br><br>
                        <strong>Essayez de me dire quelque chose comme :</strong>
                        <div class="suggestion-chips">
                            <span class="suggestion-chip" onclick="sendMessage('Je veux un graphique en barres des ventes par mois')">📊 Graphique des ventes</span>
                            <span class="suggestion-chip" onclick="sendMessage('Créer un rapport sur les performances')">📈 Rapport de performance</span>
                            <span class="suggestion-chip" onclick="sendMessage('Analyser les données de production')">🔍 Analyse production</span>
                        </div>
                    </div>
                    <div class="message-time">Maintenant</div>
                </div>
            </div>
            
            <!-- Typing Indicator -->
            <div class="typing-indicator" id="typingIndicator">
                <div style="position: relative; display: inline-block; width: 60px; height: 20px;">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                <small class="text-muted ms-3">L'IA ALTEN analyse votre demande...</small>
            </div>
            
            <!-- Input -->
            <div class="chat-input-container" style="padding: 20px; background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%); border-top: 2px solid #FFD700;">
                <!-- Case à cocher pour mode graphique -->
                <div class="chart-mode-container" id="chartModeContainer">
                    <input type="checkbox" id="chartModeCheckbox" class="chart-checkbox">
                    <label for="chartModeCheckbox" class="chart-mode-label">
                        <i class="fas fa-chart-line me-2"></i>
                        Mode Génération de Graphiques
                    </label>
                    <span class="chart-indicator" id="chartIndicator">
                        <i class="fas fa-info-circle"></i> Désactivé
                    </span>
                </div>

                <div class="input-group" style="border-radius: 25px; overflow: hidden; box-shadow: 0 4px 20px rgba(255, 215, 0, 0.2); border: 2px solid #FFD700;">
                    <input type="text" class="form-control" id="messageInput" placeholder="Dites-moi ce que vous voulez faire (ex: créer un graphique, analyser des données...)" onkeypress="handleKeyPress(event)">
                    
                    <button class="btn btn-voice" id="voiceButton">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <button class="btn btn-send" onclick="processUserMessage()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Canvas caché pour les graphiques -->
    <canvas id="chartCanvas" style="display: none;"></canvas>

    <!-- Ajout de Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Ajout de Plotly.js pour les heatmaps -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    
    <!-- Scripts existants -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        // Vérifier que Chart.js est chargé
        console.log('Chart.js chargé :', typeof Chart !== 'undefined');
        
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const typingIndicator = document.getElementById('typingIndicator');
        const chartModeCheckbox = document.getElementById('chartModeCheckbox');
        const chartModeContainer = document.getElementById('chartModeContainer');
        const chartIndicator = document.getElementById('chartIndicator');

        // Gestion du mode graphique
        chartModeCheckbox.addEventListener('change', function() {
            if (this.checked) {
                chartModeContainer.classList.add('active');
                chartIndicator.innerHTML = '<i class="fas fa-chart-line"></i> Activé';
                messageInput.placeholder = "Décrivez le graphique que vous voulez créer (ex: graphique en barres des demandes par mois)";
                addMessage("📊 <strong>Mode Graphique Activé!</strong><br>Vos requêtes seront maintenant traitées pour générer des graphiques basés sur la base de données ALTEN.");
            } else {
                chartModeContainer.classList.remove('active');
                chartIndicator.innerHTML = '<i class="fas fa-info-circle"></i> Désactivé';
                messageInput.placeholder = "Dites-moi ce que vous voulez faire (ex: créer un graphique, analyser des données...)";
                addMessage("💬 <strong>Mode Chat Normal</strong><br>Retour au mode conversation standard.");
            }
        });

        // Système de compréhension IA amélioré
        const intentPatterns = {
            'graphique': {
                keywords: ['graphique', 'graphe', 'chart', 'diagramme', 'visualisation', 'courbe', 'barres', 'secteur', 'histogramme'],
                types: ['barres', 'courbe', 'secteur', 'radar', 'histogramme', 'scatter', 'line'],
                response: "Je comprends que vous voulez créer un graphique"
            },
            'rapport': {
                keywords: ['rapport', 'report', 'analyse', 'synthèse', 'résumé', 'dashboard', 'tableau de bord'],
                response: "Je vais générer un rapport d'analyse"
            },
            'données': {
                keywords: ['données', 'data', 'informations', 'chiffres', 'statistiques', 'metrics', 'kpi'],
                response: "Je vais analyser vos données"
            },
            'performance': {
                keywords: ['performance', 'rendement', 'efficacité', 'productivité', 'résultats', 'metrics'],
                response: "Analysons les performances"
            },
            'ventes': {
                keywords: ['ventes', 'chiffre d\'affaires', 'ca', 'revenus', 'commercial', 'clients'],
                response: "Analyse des données de vente"
            },
            'production': {
                keywords: ['production', 'fabrication', 'manufacturing', 'usine', 'qualité', 'défauts'],
                response: "Analyse de la production"
            }
        };

        function analyzeIntent(message) {
            const lowerMessage = message.toLowerCase();
            let bestMatch = { intent: 'général', confidence: 0, details: {} };
            
            for (const [intent, config] of Object.entries(intentPatterns)) {
                let confidence = 0;
                let matchedKeywords = [];
                
                // Vérifier les mots-clés principaux
                for (const keyword of config.keywords) {
                    if (lowerMessage.includes(keyword)) {
                        confidence += 0.3;
                        matchedKeywords.push(keyword);
                    }
                }
                
                // Bonus pour les types spécifiques (graphiques)
                if (config.types) {
                    for (const type of config.types) {
                        if (lowerMessage.includes(type)) {
                            confidence += 0.4;
                            bestMatch.details.chartType = type;
                        }
                    }
                }
                
                // Recherche de périodes temporelles
                const timePatterns = ['mois', 'année', 'jour', 'semaine', 'trimestre', 'mensuel', 'annuel'];
                for (const period of timePatterns) {
                    if (lowerMessage.includes(period)) {
                        confidence += 0.2;
                        bestMatch.details.timePeriod = period;
                    }
                }
                
                if (confidence > bestMatch.confidence) {
                    bestMatch = {
                        intent,
                        confidence: Math.min(confidence, 1.0),
                        response: config.response,
                        matchedKeywords,
                        details: bestMatch.details
                    };
                }
            }
            
            return bestMatch;
        }

        function generateIntelligentResponse(analysis, originalMessage) {
            let response = `<div class="ai-analysis">`;
            response += `<strong><i class="fas fa-brain"></i> Analyse IA :</strong><br>`;
            response += `<span class="intent-badge">${analysis.intent.toUpperCase()}</span>`;
            response += `${analysis.response}<br>`;
            
            // Barre de confiance
            response += `<div class="confidence-bar">`;
            response += `<div class="confidence-fill" style="width: ${analysis.confidence * 100}%"></div>`;
            response += `</div>`;
            response += `<small>Confiance: ${Math.round(analysis.confidence * 100)}%</small>`;
            
            if (analysis.matchedKeywords.length > 0) {
                response += `<br><small><strong>Mots-clés détectés:</strong> ${analysis.matchedKeywords.join(', ')}</small>`;
            }
            
            response += `</div>`;
            
            // Réponse personnalisée selon l'intention
            switch (analysis.intent) {
                case 'graphique':
                    response += `<div class="chart-preview">`;
                    response += `<i class="fas fa-chart-${analysis.details.chartType === 'barres' ? 'bar' : 'line'} fa-3x" style="color: #FFD700;"></i><br>`;
                    response += `<strong>Graphique ${analysis.details.chartType || 'personnalisé'}</strong><br>`;
                    if (analysis.details.timePeriod) {
                        response += `<small>Période: ${analysis.details.timePeriod}</small><br>`;
                    }
                    response += `<button class="btn btn-sm btn-primary mt-2" onclick="generateChart('${analysis.details.chartType || 'auto'}')">`;
                    response += `<i class="fas fa-magic"></i> Générer le graphique`;
                    response += `</button>`;
                    response += `</div>`;
                    break;
                    
                case 'rapport':
                    response += `<div class="chart-preview">`;
                    response += `<i class="fas fa-file-chart fa-3x" style="color: #FF4444;"></i><br>`;
                    response += `<strong>Rapport d'analyse</strong><br>`;
                    response += `<button class="btn btn-sm btn-success mt-2" onclick="generateReport()">`;
                    response += `<i class="fas fa-file-alt"></i> Créer le rapport`;
                    response += `</button>`;
                    response += `</div>`;
                    break;
                    
                default:
                    response += `<div class="suggestion-chips">`;
                    response += `<span class="suggestion-chip" onclick="sendMessage('Créer un graphique en barres')">📊 Graphique</span>`;
                    response += `<span class="suggestion-chip" onclick="sendMessage('Générer un rapport')">📄 Rapport</span>`;
                    response += `<span class="suggestion-chip" onclick="sendMessage('Analyser les données')">🔍 Analyse</span>`;
                    response += `</div>`;
            }
            
            // Suggestions contextuelles
            response += `<br><div class="understanding-indicator">`;
            response += `<small><strong>💡 Suggestions :</strong><br>`;
            response += `• Soyez plus précis sur le type de graphique (barres, courbe, secteur)<br>`;
            response += `• Mentionnez la période d'analyse (mensuel, annuel)<br>`;
            response += `• Indiquez les variables à analyser</small>`;
            response += `</div>`;
            
            return response;
        }

        function addMessage(text, isUser = false, showAnalysis = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'bot'}`;
            
            messageDiv.innerHTML = `
                <div class="message-bubble">
                    ${text}
                </div>
                <div class="message-time">${getCurrentTime()}</div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function getCurrentTime() {
            return new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
        }

        function showTyping() {
            typingIndicator.style.display = 'block';
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function hideTyping() {
            typingIndicator.style.display = 'none';
        }

        function processUserMessage() {
            const message = messageInput.value.trim();
            if (!message) return;

            addMessage(message, true);
            messageInput.value = '';
            showTyping();

            // Déterminer l'URL selon le mode
            const isChartMode = chartModeCheckbox.checked;
            const url = isChartMode ? '/Alten/Chatbot/generate-chart/' : '/Alten/Chatbot/analyze/';
            
            if (isChartMode) {
                addMessage("📊 <em>Mode graphique activé - Génération en cours...</em>");
            }

            // Appel de la fonction appropriée
            fetch(url, {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: 'text=' + encodeURIComponent(message)
            })
            .then(response => response.json())
            .then(data => {
                hideTyping();

                if (isChartMode && data.chart_data) {
                    // Vérifier si c'est une heatmap
                    if (data.is_heatmap) {
                        displayHeatmapChart(data);
                    } else {
                        // Afficher le graphique généré avec Chart.js
                        displayGeneratedChart(data);
                    }
                } else if (data.is_table) {
                    // Mode tableau normal
                    let tableHTML = "<table class='table table-bordered table-striped mt-2'>";
                    tableHTML += "<thead><tr>";
                    data.columns.forEach(col => tableHTML += `<th>${col}</th>`);
                    tableHTML += "</tr></thead><tbody>";
                    data.result.forEach(row => {
                        tableHTML += "<tr>";
                        Object.values(row).forEach(val => tableHTML += `<td>${val}</td>`);
                        tableHTML += "</tr>";
                    });
                    tableHTML += "</tbody></table>";
                    addMessage(`<strong>ChatBot Alten :</strong><br>${tableHTML}`);
                } else if (data.result) {
                    addMessage(`<strong>ChatBot Alten :</strong><br>${data.result}`);
                } else if (data.error) {
                    addMessage(`❌ Erreur d'analyse :<br><span style='color:red'>${data.error}</span> recharger la page svp`);
                } else {
                    addMessage("❌ Erreur d'analyse inconnue. rechargez la page svp");
                }
            })
            .catch(error => {
                hideTyping();
                console.error('Erreur:', error);
                addMessage("❌ Erreur de connexion. Vérifiez votre réseau.");
            });
        }

        function displayGeneratedChart(data) {
            const chartContainer = document.createElement('div');
            chartContainer.className = 'generated-chart';
            
            // Créer un canvas pour le graphique
            const canvas = document.createElement('canvas');
            canvas.id = 'chart-' + Date.now();
            canvas.width = 600;
            canvas.height = 400;
            
            chartContainer.innerHTML = `
                <h5><i class="fas fa-chart-bar"></i> ${data.title || 'Graphique Généré'}</h5>
                <div style="position: relative; height: 400px;">
                    ${canvas.outerHTML}
                </div>
                <div class="mt-3">
                    <button class="btn btn-sm btn-outline-primary me-2" onclick="downloadChart('${canvas.id}')">
                        <i class="fas fa-download"></i> Télécharger
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="regenerateChart()">
                        <i class="fas fa-redo"></i> Régénérer
                    </button>
                </div>
            `;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message bot';
            messageDiv.appendChild(chartContainer);
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Utiliser Chart.js pour créer le graphique
            setTimeout(() => {
                const actualCanvas = document.getElementById(canvas.id);
                if (actualCanvas) {
                    console.log('Données du graphique:', data.chart_data);
                    new Chart(actualCanvas, {
                        type: data.chart_data.type || 'bar',  // Utiliser le type spécifié dans les données
                        data: data.chart_data.data,
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                title: {
                                    display: true,
                                    text: data.title || 'Graphique ALTEN'
                                },
                                legend: {
                                    display: true,
                                    position: 'top'
                                }
                            },
                            scales: data.chart_data.options?.scales || (data.chart_data.type === 'pie' || data.chart_data.type === 'doughnut' ? {} : {
                                y: {
                                    beginAtZero: true
                                }
                            })
                        }
                    });
                } else {
                    console.error('Canvas non trouvé:', canvas.id);
                }
            }, 100);
        }

        // Nouvelle fonction pour afficher les heatmaps avec Plotly.js
        function displayHeatmapChart(data) {
            const chartContainer = document.createElement('div');
            chartContainer.className = 'generated-chart';
            
            // Créer un div pour le graphique Plotly
            const plotDiv = document.createElement('div');
            plotDiv.id = 'plot-' + Date.now();
            plotDiv.style.width = '100%';
            plotDiv.style.height = '400px';
            
            chartContainer.innerHTML = `
                <h5><i class="fas fa-chart-bar"></i> ${data.title || 'Graphique Généré'}</h5>
                <div style="position: relative; height: 400px;">
                    ${plotDiv.outerHTML}
                </div>
                <div class="mt-3">
                    <button class="btn btn-sm btn-outline-primary me-2" onclick="downloadPlotlyChart('${plotDiv.id}')">
                        <i class="fas fa-download"></i> Télécharger
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="regenerateChart()">
                        <i class="fas fa-redo"></i> Régénérer
                    </button>
                </div>
            `;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message bot';
            messageDiv.appendChild(chartContainer);
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Utiliser Plotly.js pour créer la heatmap
            setTimeout(() => {
                const actualPlotDiv = document.getElementById(plotDiv.id);
                if (actualPlotDiv && data.chart_data) {
                    const plotData = [{
                        z: data.chart_data.data.z,
                        x: data.chart_data.data.x,
                        y: data.chart_data.data.y,
                        type: 'heatmap',
                        colorscale: data.chart_data.data.colorscale || [
                            [0, 'rgb(247, 251, 255)'],
                            [0.2, 'rgb(222, 235, 247)'],
                            [0.4, 'rgb(198, 219, 239)'],
                            [0.6, 'rgb(158, 202, 225)'],
                            [0.8, 'rgb(107, 174, 214)'],
                            [1, 'rgb(49, 130, 189)']
                        ],
                        showscale: true,
                        colorbar: data.chart_data.data.colorbar || {
                            title: {
                                text: 'Nombre de cas',
                                font: { size: 14 }
                            },
                            thickness: 20,
                            len: 0.7
                        },
                        hovertemplate: data.chart_data.data.hovertemplate || '<b>%{y}</b> priorité<br><b>%{x}</b> criticité<br><b>%{z}</b> cas de test<extra></extra>',
                        text: data.chart_data.data.text || data.chart_data.data.z,
                        texttemplate: '%{z}',
                        textfont: data.chart_data.data.textfont || {
                            size: 16,
                            color: 'white',
                            family: 'Arial Black'
                        }
                    }];
                    
                    const layout = {
                        title: {
                            text: data.chart_data.layout.title?.text || data.title || 'Matrice Priorité/Criticité',
                            font: { size: 18, color: '#2c3e50' },
                            x: 0.5
                        },
                        xaxis: {
                            title: {
                                text: data.chart_data.layout.xaxis?.title?.text || 'Niveau de Criticité',
                                font: { size: 14, color: '#34495e' }
                            },
                            tickfont: { size: 12, color: '#2c3e50' },
                            side: 'bottom'
                        },
                        yaxis: {
                            title: {
                                text: data.chart_data.layout.yaxis?.title?.text || 'Niveau de Priorité',
                                font: { size: 14, color: '#34495e' }
                            },
                            tickfont: { size: 12, color: '#2c3e50' }
                        },
                        margin: { l: 80, r: 100, t: 80, b: 80 },
                        plot_bgcolor: 'white',
                        paper_bgcolor: 'white',
                        font: { family: 'Arial, sans-serif' }
                    };
                    
                    const config = {
                        responsive: true,
                        displayModeBar: true,
                        displaylogo: false,
                        modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d', 'autoScale2d'],
                        toImageButtonOptions: {
                            format: 'png',
                            filename: 'matrice_priorite_criticite',
                            height: 600,
                            width: 800,
                            scale: 2
                        }
                    };
                    
                    Plotly.newPlot(actualPlotDiv, plotData, layout, config);
                }
            }, 100);
        }

        // Fonction pour télécharger les graphiques Plotly
        function downloadPlotlyChart(plotId) {
            const plotDiv = document.getElementById(plotId);
            if (plotDiv) {
                Plotly.toImage(plotDiv, {
                    format: 'png',
                    width: 800,
                    height: 600
                }).then(function(url) {
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'heatmap-alten.png';
                    a.click();
                });
            }
        }

        function downloadChart(canvasId) {
            const canvas = document.getElementById(canvasId);
            const url = canvas.toDataURL('image/png');
            const a = document.createElement('a');
            a.href = url;
            a.download = 'graphique-alten.png';
            a.click();
        }

        function regenerateChart() {
            addMessage("🔄 Régénération du graphique...");
            // Logique de régénération
        }

        function sendMessage(text) {
            messageInput.value = text;
            processUserMessage();
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                processUserMessage();
            }
        }

        function generateChart(type) {
            showTyping();
            addMessage(`🚀 Génération du graphique ${type} en cours...`, true);
            
            setTimeout(() => {
                hideTyping();
                addMessage(`✅ <strong>Graphique généré avec succès!</strong><br>
                    <div class="chart-preview">
                        <i class="fas fa-chart-bar fa-4x" style="color: #FFD700;"></i><br>
                        <strong>Graphique ${type}</strong><br>
                        <button class="btn btn-sm btn-outline-primary mt-2">
                            <i class="fas fa-download"></i> Télécharger
                        </button>
                    </div>`);
            }, 2000);
        }

        function generateReport() {
            showTyping();
            addMessage("📊 Génération du rapport d'analyse...", true);
            
            setTimeout(() => {
                hideTyping();
                addMessage(`📋 <strong>Rapport généré!</strong><br>
                    <div class="ai-analysis">
                        <strong>Résumé exécutif:</strong><br>
                        • ${Math.floor(Math.random() * 1000 + 500)} lignes de données analysées<br>
                        • ${Math.floor(Math.random() * 20 + 5)} variables identifiées<br>
                        • Tendances positives détectées<br>
                        • Recommandations générées<br><br>
                        <button class="btn btn-sm btn-success">
                            <i class="fas fa-file-pdf"></i> Télécharger PDF
                        </button>
                    </div>`);
            }, 3000);
        }

        // Reconnaissance vocale améliorée avec gestion d'erreurs
        function setupVoiceRecognition() {
            const voiceButton = document.getElementById('voiceButton');
            
            // Vérifier le support de la reconnaissance vocale
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                voiceButton.disabled = true;
                voiceButton.title = "Reconnaissance vocale non supportée par ce navigateur";
                voiceButton.innerHTML = '<i class="fas fa-microphone-slash"></i>';
                return;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new SpeechRecognition();
            
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'fr-FR';
            recognition.maxAlternatives = 1;

            let isListening = false;

            voiceButton.addEventListener('click', async () => {
                if (isListening) {
                    recognition.stop();
                    return;
                }

                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    stream.getTracks().forEach(track => track.stop());
                    
                    recognition.start();
                    isListening = true;
                    voiceButton.classList.add('listening');
                    messageInput.placeholder = "🎤 Écoute en cours... Parlez maintenant!";
                    
                    addMessage("🎤 <em>Microphone activé - Parlez clairement...</em>");
                    
                } catch (error) {
                    console.error('Erreur microphone:', error);
                    let errorMessage = "❌ ";
                    
                    if (error.name === 'NotAllowedError') {
                        errorMessage += "Permission microphone refusée. Veuillez autoriser l'accès au microphone dans les paramètres de votre navigateur.";
                    } else if (error.name === 'NotFoundError') {
                        errorMessage += "Aucun microphone détecté. Vérifiez votre matériel audio.";
                    } else {
                        errorMessage += `Erreur microphone: ${error.message}`;
                    }
                    
                    addMessage(errorMessage);
                    
                    voiceButton.disabled = true;
                    setTimeout(() => {
                        voiceButton.disabled = false;
                    }, 3000);
                }
            });

            recognition.onstart = () => {
                voiceButton.innerHTML = '<i class="fas fa-stop"></i>';
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                const confidence = event.results[0][0].confidence;
                
                messageInput.value = transcript;
                messageInput.placeholder = chartModeCheckbox.checked 
                    ? "Décrivez le graphique que vous voulez créer..." 
                    : "Dites-moi ce que vous voulez faire...";
                
                const confidencePercent = Math.round(confidence * 100);
                addMessage(`🎤 <strong>Reconnaissance vocale</strong> (${confidencePercent}% confiance):<br>"${transcript}"`, true);
                
                if (confidence > 0.7) {
                    setTimeout(() => processUserMessage(), 800);
                } else {
                    addMessage("🤔 <em>Confiance faible. Voulez-vous reformuler ou corriger le texte?</em>");
                }
            };

            recognition.onspeechstart = () => {
                addMessage("🗣️ <em>Parole détectée...</em>");
            };

            recognition.onspeechend = () => {
                addMessage("✅ <em>Fin de parole détectée</em>");
            };

            recognition.onerror = (event) => {
                console.error('Erreur reconnaissance vocale:', event.error);
                isListening = false;
                voiceButton.classList.remove('listening');
                voiceButton.innerHTML = '<i class="fas fa-microphone"></i>';
                messageInput.placeholder = chartModeCheckbox.checked 
                    ? "Décrivez le graphique que vous voulez créer..." 
                    : "Dites-moi ce que vous voulez faire...";
                
                let errorMessage = "❌ ";
                
                switch (event.error) {
                    case 'not-allowed':
                        errorMessage += "<strong>Permission refusée</strong><br>Veuillez autoriser l'accès au microphone.";
                        break;
                    case 'no-speech':
                        errorMessage += "Aucune parole détectée. Rapprochez-vous du microphone.";
                        break;
                    case 'audio-capture':
                        errorMessage += "Microphone non accessible. Vérifiez votre matériel.";
                        break;
                    case 'network':
                        errorMessage += "Erreur réseau. Vérifiez votre connexion.";
                        break;
                    default:
                        errorMessage += `Erreur technique: ${event.error}`;
                }
                
                addMessage(errorMessage);
            };

            recognition.onend = () => {
                isListening = false;
                voiceButton.classList.remove('listening');
                voiceButton.innerHTML = '<i class="fas fa-microphone"></i>';
                messageInput.placeholder = chartModeCheckbox.checked 
                    ? "Décrivez le graphique que vous voulez créer..." 
                    : "Dites-moi ce que vous voulez faire...";
            };
        }

        // Initialisation
        messageInput.focus();
        setupVoiceRecognition();

        // Messages de bienvenue
        setTimeout(() => {
            addMessage(`💡 <strong>Nouvelle fonctionnalité - Mode Graphique!</strong><br>
                • Cochez la case "Mode Génération de Graphiques" pour créer des visualisations<br>
                • Basé sur votre base de données ALTEN (Demandes, Applications, Audits, etc.)<br>
                • Exemples: "graphique des demandes par mois", "évolution des audits"<br><br>
                🎤 <strong>Reconnaissance vocale disponible</strong><br>
                Cliquez sur <i class="fas fa-microphone"></i> et parlez clairement!`);
        }, 2000);
    </script>
</body>
</html>